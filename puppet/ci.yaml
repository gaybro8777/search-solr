# Puppet CI Resources

classes:
  - nsidc_jenkins
  - nsidc_nfs

# NFS Mounts
nsidc_nfs::sharemounts:
  /share/sw/packages:
    project: sw
    share: packages

# Jenkins Plugins
nsidc_jenkins::plugins:
  git: {}
  git-client: {}
  git-parameter: {}
  scm-api: {}
  credentials: {}
  ssh-credentials: {}
  greenballs: {}
  jobConfigHistory: {}
  mailer: {}
  instant-messaging: {}
  jabber: {}
  ansicolor: {}
  simple-theme-plugin: {}

search-solr-tools-name: search-solr-tools
search_solr_tools_repo: git@github.com:nsidc/search-solr-tools.git
deploy_solr_tools_command: |
  rm -rf .vagrant-$ENV
  vagrant nsidc hijack --env=$ENV --project=search-solr || true

  VERSION=""
  if [ ! -z "$gem_version" ]; then
    VERSION="-v $gem_version"
  fi

  vagrant nsidc ssh --env=$ENV --project=search-solr -c "sudo gem install search_solr_tools $VERSION -s http://snowhut.apps.int.nsidc.org/shares/export/sw/packages/ruby/nsidc"

provision_solr_command: |
  rm -rf .vagrant-$ENV
  (vagrant nsidc hijack --env=$ENV || true)
  (vagrant nsidc destroy --env=$ENV || true)
  vagrant nsidc up --env=$ENV
  bundle exec rake jenkins:release:tag_deployment[$ENV]

harvest_nsidc_command: |
  rm -rf .vagrant-$ENV
  (vagrant nsidc hijack --env=$ENV --project=search-solr || true)
  vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data_center=nsidc --environment=$ENV"
  vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data_center=nsidc_auto_suggest --environment=$ENV"

harvest_ade_command: |
  rm -rf .vagrant-$ENV
  (vagrant nsidc hijack --env=$ENV --project=search-solr || true)
  vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data_center=cisl echo eol ices nmi nodc rda usgs bco_dmo tdar pdc r2r ade_auto_suggest --environment=$ENV"


# Jenkins Jobs
nsidc_jenkins::jobs:
  # clone the project into the shared workspace
  "A01_%{hiera('project')}_Integration_Checkout_Project":
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/integration
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: master
    git:
      repo: "%{hiera('gitrepo')}"
      poll_scm: true
      checkout_local: false
    command: |
      git checkout $ref
    trigger_job: "A02_%{hiera('project')}_Integration_Install_Dependencies"

  "A02_%{hiera('project')}_Integration_Install_Dependencies":
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/integration
    command: bundle install
    trigger_job: "A03_%{hiera('project')}_Integration_Provision"

  "A03_%{hiera('project')}_Integration_Provision":
    command: |
      ENV=integration
      %{hiera('provision_solr_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/integration
    trigger_job: "A04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem"

  "A04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/integration
    parameters:
      - type: string
        name: gem_version
        description: >-
          The version of search_solr_tools to install; if none is given, the
          latest (non-prerelease) release will be installed.
        default: ""
    command: |
      ENV=integration
      %{hiera('deploy_solr_tools_command')}
    trigger_job: "A05_%{hiera('search-solr-tools-name')}_Integration_Harvest_NSIDC"

  "A05_%{hiera('search-solr-tools-name')}_Integration_Harvest_NSIDC":
    command: |
      ENV=integration
      %{hiera('harvest_nsidc_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/integration
    trigger_job: "A06_%{hiera('search-solr-tools-name')}_Integration_Harvest_ADE"

  "A06_%{hiera('search-solr-tools-name')}_Integration_Harvest_ADE":
    command: |
      ENV=integration
      %{hiera('harvest_ade_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/integration
    trigger_job: "A07_%{hiera('project')}_Integration_Acceptance_Tests"

  "A07_%{hiera('project')}_Integration_Acceptance_Tests":
    command: |
      ENV=integration
      rm -rf .vagrant-$ENV
      (vagrant nsidc hijack --env=$ENV --project=search-solr || true)
      vagrant nsidc ssh --env=$ENV --project=search-solr -c 'cd /opt/search-solr; bundle install --path=.gem; bundle exec rake spec:acceptance'
    workspace: /var/lib/jenkins/workspaces/search-solr/integration

  "B01_%{hiera('project')}_QA_Checkout_Project":
    git:
      repo: "%{hiera('gitrepo')}"
      wipe_workspace: true
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: master
    command: |
      git checkout $ref
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/qa
    trigger_job: "B02_%{hiera('project')}_QA_Install_Dependencies"

  "B02_%{hiera('project')}_QA_Install_Dependencies":
    command: bundle install
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/qa
    trigger_job: "B03_%{hiera('project')}_QA_Provision"

  "B03_%{hiera('project')}_QA_Provision":
    command: |
      ENV=qa
      %{hiera('provision_solr_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/qa
    trigger_job: "B04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem"

  "B04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/qa
    parameters:
      - type: string
        name: gem_version
        description: >-
          The version of search_solr_tools to install; if none is given, the
          latest (non-prerelease) release will be installed.
        default: ""
    command: |
      ENV=qa
      %{hiera('deploy_solr_tools_command')}
    trigger_job: "B05_%{hiera('search-solr-tools-name')}_QA_Harvest_NSIDC"

  "B05_%{hiera('search-solr-tools-name')}_QA_Harvest_NSIDC":
    command: |
      ENV=qa
      %{hiera('harvest_nsidc_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/qa
    trigger_job: "B06_%{hiera('search-solr-tools-name')}_QA_Harvest_ADE"

  "B06_%{hiera('search-solr-tools-name')}_QA_Harvest_ADE":
    command: |
      ENV=qa
      %{hiera('harvest_ade_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/qa
    trigger_job: "B07_%{hiera('project')}_QA_Acceptance_Tests"

  "B07_%{hiera('project')}_QA_Acceptance_Tests":
    command: |
      ENV=qa
      rm -rf .vagrant-$ENV
      (vagrant nsidc hijack --env=$ENV --project=search-solr || true)
      vagrant nsidc ssh --env=$ENV --project=search-solr -c 'cd /opt/search-solr; bundle install --path=.gem; bundle exec rake spec:acceptance'
    workspace: /var/lib/jenkins/workspaces/search-solr/qa

  "C01_%{hiera('project')}_Staging_Checkout_Project":
    git:
      repo: "%{hiera('gitrepo')}"
      wipe_workspace: true
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: qa
    command: |
      git checkout $ref
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/staging
    trigger_job: "C02_%{hiera('project')}_Staging_Install_Dependencies"

  "C02_%{hiera('project')}_Staging_Install_Dependencies":
    command: bundle install
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/staging
    trigger_job: "C03_%{hiera('project')}_Staging_Provision"

  "C03_%{hiera('project')}_Staging_Provision":
    command: |
      ENV=staging
      %{hiera('provision_solr_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/staging
    trigger_job: "C04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem"

  "C04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/staging
    parameters:
      - type: string
        name: gem_version
        description: >-
          The version of search_solr_tools to install; if none is given, the
          latest (non-prerelease) release will be installed.
        default: ""
    command: |
      ENV=staging
      %{hiera('deploy_solr_tools_command')}
    trigger_job: "C05_%{hiera('search-solr-tools-name')}_Staging_Harvest_NSIDC"

  "C05_%{hiera('search-solr-tools-name')}_Staging_Harvest_NSIDC":
    command: |
      ENV=staging
      %{hiera('harvest_nsidc_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/staging
    trigger_job: "C06_%{hiera('search-solr-tools-name')}_Staging_Harvest_ADE"

  "C06_%{hiera('search-solr-tools-name')}_Staging_Harvest_ADE":
    command: |
      ENV=staging
      %{hiera('harvest_ade_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/staging
    trigger_job: "C07_%{hiera('project')}_Staging_Acceptance_Tests"

  "C07_%{hiera('project')}_Staging_Acceptance_Tests":
    command: |
      ENV=staging
      rm -rf .vagrant-$ENV
      (vagrant nsidc hijack --env=$ENV --project=search-solr || true)
      vagrant nsidc ssh --env=$ENV --project=search-solr -c 'cd /opt/search-solr; bundle install --path=.gem; bundle exec rake spec:acceptance'
    workspace: /var/lib/jenkins/workspaces/search-solr/staging
    trigger_job: "D01_%{hiera('search-solr-tools-name')}_Blue_Checkout_Project"


  "D01_%{hiera('project')}_Blue_Provision":
    git:
      repo: "%{hiera('gitrepo')}"
      wipe_workspace: true
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: staging
    command: |
      ENV=blue
      git checkout $ref
      bundle install
      %{hiera('provision_solr_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/blue
    trigger_job: "D02_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem"

  "D02_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/blue
    parameters:
      - type: string
        name: gem_version
        description: >-
          The version of search_solr_tools to install; if none is given, the
          latest (non-prerelease) release will be installed.
        default: ""
    command: |
      ENV=blue
      %{hiera('deploy_solr_tools_command')}
    trigger_job: "D03_%{hiera('search-solr-tools-name')}_Blue_Harvest_NSIDC"

  "D03_%{hiera('search-solr-tools-name')}_Blue_Harvest_NSIDC":
    command: |
      ENV=blue
      %{hiera('harvest_nsidc_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/blue
    trigger_job: "D04_%{hiera('search-solr-tools-name')}_Blue_Harvest_ADE"

  "D04_%{hiera('search-solr-tools-name')}_Blue_Harvest_ADE":
    command: |
      ENV=blue
      %{hiera('harvest_ade_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/blue

  "E01_%{hiera('project')}_Release_Bump_Version":
    git:
      repo: "%{hiera('gitrepo')}"
      wipe_workspace: true
    parameters:
      - type: string
        name: branch
        description: git branch to checkout and tag
        default: master
      - type: choice
        name: version_part
        choices:
        - patch
        - minor
        - major
    command: |
      git checkout $branch

      bundle install
      bundle exec rake jenkins:release:bump[$version_part]
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/release
    trigger_job: "E02_%{hiera('project')}_Release_Push_to_Git"

  "E02_%{hiera('project')}_Release_Push_to_Git":
    command: bundle exec rake jenkins:release:push
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/release
